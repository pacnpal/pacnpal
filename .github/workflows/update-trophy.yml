name: Update Trophy

on:
  schedule:
    - cron: "0 0 * * *" # Runs once daily at midnight
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Generate trophy image
        run: |
          # Fetch the trophy SVG from the service with fallback URLs
          TROPHY_PARAMS="username=${{ github.repository_owner }}&theme=onedark&column=7&margin-w=15&margin-h=15"
          
          # Try main endpoint first, then fallback endpoints
          ENDPOINTS=(
            "https://github-profile-trophy.vercel.app"
            "https://github-profile-trophy-liard-delta.vercel.app"
            "https://github-profile-trophy-fork-two.vercel.app"
            "https://github-profile-trophy-winning.vercel.app"
          )
          
          SUCCESS=false
          for ENDPOINT in "${ENDPOINTS[@]}"; do
            echo "Trying endpoint: $ENDPOINT"
            if curl -s -f "$ENDPOINT/?$TROPHY_PARAMS" -o profile/trophy.svg && [ -s profile/trophy.svg ]; then
              echo "Successfully fetched trophy from $ENDPOINT"
              SUCCESS=true
              break
            else
              echo "Failed to fetch from $ENDPOINT, trying next..."
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "Error: Failed to fetch trophy.svg from all endpoints"
            exit 1
          fi

      - name: Fix SVG formatting
        run: |
          # Remove leading whitespace from SVG files so they render properly on GitHub
          python3 << 'EOF'
          filename = 'profile/trophy.svg'
          with open(filename, 'r') as f:
              lines = f.readlines()
          
          # Skip to the first non-empty line
          start_idx = None
          for i, line in enumerate(lines):
              if line.strip():
                  start_idx = i
                  break
          
          # Only process if we found a non-empty line
          if start_idx is not None:
              # Strip leading whitespace from the first non-empty line
              lines[start_idx] = lines[start_idx].lstrip()
              
              # Write back starting from the first non-empty line
              with open(filename, 'w') as f:
                  f.writelines(lines[start_idx:])
          EOF

      - name: Commit trophy
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add profile/trophy.svg
          git commit -m "Update trophy.svg with latest achievements" || exit 0
          git push
